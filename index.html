<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sales Summary</title>
    <style>
        /* Reset some default styles */
        * {
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 1.5rem;
            background-color: #f9f9f9;
            color: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        header {
            margin-bottom: 2rem;
            text-align: center;
        }
        h1 {
            font-weight: 700;
            font-size: 2rem;
            margin: 0;
            color: #2c3e50;
        }
        main {
            background: white;
            padding: 2rem 2.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 1rem;
            color: #34495e;
        }
        input[type="file"] {
            width: 100%;
            padding: 0.4rem;
            font-size: 1rem;
            cursor: pointer;
        }
        #total-sales {
            margin-top: 2rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #27ae60;
            min-height: 1.5em;
        }
        .error {
            margin-top: 1rem;
            color: #e74c3c;
            font-weight: 600;
        }
        @media (max-width: 480px) {
            main {
                padding: 1.5rem 1.5rem;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Sales Summary</h1>
    </header>
    <main>
        <label for="fileInput">Upload sales.csv file:</label>
        <input type="file" id="fileInput" accept=".csv,text/csv" aria-describedby="fileHelp" />
        <div id="total-sales"></div>
        <div id="error-message" class="error" role="alert" aria-live="polite"></div>
    </main>

    <script>
    /**
     * Base64 decode function for browser compatibility
     * Uses atob internally
     * @param {string} base64Str
     * @returns {string} decoded string
     */
    function base64Decode(base64Str) {
        try {
            return atob(base64Str);
        } catch (e) {
            return null;
        }
    }

    /**
     * Parse CSV string into array of objects
     * Assumes first line contains headers
     * Supports simple CSV without quoted fields
     * @param {string} csvText
     * @returns {Array<Object>} parsed data
     */
    function parseCSV(csvText) {
        const lines = csvText.trim().split(/\r?\n/);
        if (lines.length < 2) return [];
        const headers = lines[0].split(",").map(h => h.trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(",");
            if (row.length !== headers.length) {
                // Skip malformed rows
                continue;
            }
            const obj = {};
            for (let j = 0; j < headers.length; j++) {
                obj[headers[j]] = row[j].trim();
            }
            data.push(obj);
        }
        return data;
    }

    /**
     * Format a number to fixed 2 decimals without rounding errors
     * @param {number} num
     * @returns {string} formatted string
     */
    function formatNumber(num) {
        return num.toFixed(2);
    }

    /**
     * Main function to handle the file input change
     * @param {Event} e
     */
    function handleFileInput(e) {
        const file = e.target.files[0];
        const totalSalesEl = document.getElementById('total-sales');
        const errorEl = document.getElementById('error-message');

        // Clear previous outputs
        totalSalesEl.textContent = '';
        errorEl.textContent = '';

        if (!file) {
            errorEl.textContent = 'No file selected.';
            return;
        }

        if (file.name !== 'sales.csv') {
            errorEl.textContent = 'Please upload the file named sales.csv.';
            return;
        }

        const reader = new FileReader();

        reader.onload = function(event) {
            try {
                const csvText = event.target.result;
                // Parse CSV
                const data = parseCSV(csvText);

                if (data.length === 0) {
                    errorEl.textContent = 'CSV file is empty or malformed.';
                    return;
                }

                // Sum the sales column
                let sum = 0;
                for (const row of data) {
                    if (!('sales' in row)) {
                        errorEl.textContent = "CSV file missing 'sales' column.";
                        return;
                    }
                    const val = parseFloat(row.sales);
                    if (isNaN(val)) {
                        errorEl.textContent = "Invalid number found in 'sales' column.";
                        return;
                    }
                    sum += val;
                }

                // Format sum to 2 decimals
                // The brief requires the exact text content to be '650.75' (which matches the sum of given CSV values)
                const formattedSum = formatNumber(sum);

                totalSalesEl.textContent = formattedSum;
            } catch (err) {
                errorEl.textContent = 'Error processing the file.';
            }
        };

        reader.onerror = function() {
            errorEl.textContent = 'Error reading the file.';
        };

        reader.readAsText(file);
    }

    // Set up event listener on input
    document.getElementById('fileInput').addEventListener('change', handleFileInput);

    // Auto-load the provided sales.csv from data URI and display total automatically on page load
    // Per brief: The app must process the attached sales.csv file with base64 content provided.
    // So we decode the base64 from the brief and process it immediately without user interaction.

    (function autoLoadAttachedCSV() {
        // Base64 content from the brief:
        const base64CSV = 'cHJvZHVjdCxzYWxlcwpBcHAyMCwxNTAuNTAKQmFuYW5hLDIwMC4yNQpDaGVycnksMzAw';
        const csvText = base64Decode(base64CSV);
        if (!csvText) {
            // If decoding fails, do nothing
            return;
        }

        // Parse CSV
        const data = parseCSV(csvText);
        if (data.length === 0) {
            return;
        }

        // Sum sales column
        let sum = 0;
        for (const row of data) {
            if (!('sales' in row)) {
                return;
            }
            const val = parseFloat(row.sales);
            if (isNaN(val)) {
                return;
            }
            sum += val;
        }

        // Format sum
        const formattedSum = formatNumber(sum);

        // Set total-sales text content
        const totalSalesEl = document.getElementById('total-sales');
        totalSalesEl.textContent = formattedSum;
    })();
    </script>
</body>
</html>
